define(["avalon"],function(a){function b(a,b,c,d){return this.offset=a,this.size=b,this.index=c,this.fileObj=d,this.uploadedBytes=0,this.retried=0,this.successEventBusToken=d.fileLocalToken+"#"+this.index+"success",this.errorEventBusToken=d.fileLocalToken+"#"+this.index+"error",this}return b.prototype.upload=function(a){this.uploadConfig=a;var b=this.fileObj;return b.__flashfile?this.__flashupload(a):(this.__html5upload(a),!0)},b.prototype.cancelUpload=function(){return!0},b.prototype.__flashupload=function(a){var b=this.fileObj;return 0==this.retried&&(this.bindFlashEventHub(),a.onSuccess=this.successEventBusToken,a.onError=this.errorEventBusToken,a.paramConfig=this.__extraRequestData(a.paramConfig)),this.log("FileUploader: blob sending. Index: ",this.index),b.flashEventHub.sendFlashMessage("uploadBlob",b.fileLocalToken,this.offset,this.size,a),!0},b.prototype.bindFlashEventHub=function(){var a=this.fileObj;a.flashEventHub&&(a.flashEventHub.addEventListener(this.successEventBusToken,this.onSuccess,this),a.flashEventHub.addEventListener(this.errorEventBusToken,this.onError,this))},b.prototype.unbindFlashEventHub=function(){var a=this.fileObj;a.flashEventHub&&(a.flashEventHub.removeEventListener(this.successEventBusToken,this.onSuccess,this),a.flashEventHub.removeEventListener(this.errorEventBusToken,this.onError,this))},b.prototype.__extraRequestData=function(b){var d=b.requiredParamsConfig.blobParamName,e=b.requiredParamsConfig.fileTokenParamName,f=b.requiredParamsConfig.totalChunkParamName,g=b.requiredParamsConfig.chunkIndexParamName,h=b.requiredParamsConfig.fileNameParamName,i=b.customizedParams,j=b.requiredParamsConfig.blobMd5ParamName,k={};return this.fileObj.fileKey&&(k[e]=this.fileObj.fileKey),k[f]=this.fileObj.blobs.length,k[g]=this.index,k[h]=this.fileObj.name,this.md5&&(k[j]=this.md5),k=a.mix(k,i),k.__dataField=d,k},b.prototype.onProgress=function(a){this.uploadedBytes=this.uploadedBytes,this.dispatchEvent("blobProgressed",this,a)},b.prototype.onSuccess=function(a,b,c){this.unbindFlashEventHub(),delete this.uploadConfig,this.uploadedBytes=this.size,this.dispatchEvent("blobUploaded",this,c.responseText,b)},b.prototype.onError=function(a,b){this.retried++;var c=this.uploadConfig.blobRetryTimes?this.uploadConfig.blobRetryTimes:0;if(this.retried<c)this.log("FileUploader: fail to upload blob. Retrying for ",this.retried," time(s)."),this.upload(this.uploadConfig);else{if("timeout"==a){alert("\u56fe\u7247\u4e0a\u4f20\u8d85\u65f6\uff0c\u8bf7\u91cd\u8bd5");var d=$("#"+this.fileObj.fileLocalToken)[0];d.click(),this.onPreviewRemoveClicked()}delete this.uploadConfig,this.unbindFlashEventHub(),this.dispatchEvent("blobErrored",this,a)}},b.prototype.__html5upload=function(c){var d=this,e=this.__extraRequestData(c.paramConfig);e[e.__dataField]=this.fileObj.data.slice(this.offset,this.offset+this.size);var f=new FormData;for(var g in e)e.hasOwnProperty(g)&&f.append(g,e[g]);var i=({fileLocalToken:this.fileObj.fileLocalToken,blob:this},{type:"post",url:c.url,form:f,timeout:c.timeout||3e4,password:c.password,username:c.userName,success:function(){d.onSuccess.apply(d,arguments)},cache:!1,progressCallback:function(a){a.lengthComputable&&d.onProgress(a.loaded)},error:function(a,b,c){d.onError(b,c)}});try{return this.request=a.ajax(i),!0}catch(j){return this.dispatchEvent("blobErrored",b,j.message),!1}},b});