define(["avalon","text!"+_WEB_Cfg.domain+"/fileuploader.html","browser",_WEB_Cfg.jsLibPath+"fileuploader/eventmixin.min.js",_WEB_Cfg.jsLibPath+"fileuploader/blob.min.js",_WEB_Cfg.jsLibPath+"fileuploader/file.min.js",_WEB_Cfg.jsLibPath+"fileuploader/flasheventhub.min.js",_WEB_Cfg.jsLibPath+"fileuploader/runtime.min.js",_WEB_Cfg.jsLibPath+"fileuploader/blobqueue.min.js",_WEB_Cfg.jsLibPath+"fileuploader/spark-md5.min.js",_WEB_Cfg.jsLibPath+"fileuploader/inputproxy.min.js","mmRequest","css!"+_WEB_Cfg.staticPath+"css/uploader.css"],function(a,b,c,d,e,f,g,h,j,k,l){var m="fileuploader",n=a.ui[m]=function(c,i,n){var o=i[m+"Options"],q=(a(c),a.define(i[m+"Id"],function(i){a.mix(i,o),a.mix(i.$serverConfigDefault,i.serverConfig),a.mix(i.$requiredParamsConfig,i.requiredParamsConfig);var m=void 0!=document.createElement("input").multiple,p=void 0!=window.File,r=document.createElement("canvas").getContext&&document.createElement("canvas").getContext("2d"),s="ie"==a.browser.name.toLowerCase(),t=a.browser.version;i.$supportBase64Img=!s||t>=8,i.$base64Limitation=s&&8==t?32768:Number.MAX_VALUE,i.useHtml5Runtime=m&&p&&r,i.useFlashRuntime=!i.useHtml5Runtime,i.previews=[],d(e),d(l),d(j),d(h),d(f),i.$md5gen=k,i.$runtime=null,i.$flashEventHub=void 0,i.$fileInputProxy=void 0,i.$fileInputProxy=new l({fn:i.getFileContext,scope:i}),i.$fileInputProxy.addEventListener("newFileSelected",function(a){var b=new f(a,this.$flashEventHub,this.chunked,this.chunkSize,e);b.addEventListener("fileStatusChanged",this.onFileStatusChanged,this),b.addEventListener("fileProgressed",function(a,b){var c=this.getPreviewByToken(this,a.fileLocalToken);c&&(c.message=this.getFileMessageText(a),c.uploadProgress=a.uploadedPercentage)},this),b.addEventListener("requestDone",this.onFileRequestResponsed,this),this.$runtime.addFile(b);var c={name:a.name,fileLocalToken:a.fileLocalToken,preview:a.preview,uploadProgress:a.progress,uploadStatus:b.status,done:!1,size:b.size,message:this.getFileMessageText(b)};this.previews.push(c),i.uploadFile(i,c.fileLocalToken)},i),i.$fileInputProxy.addEventListener("previewGenerated",function(a,b){var c=this.getPreviewByToken(this,a);c&&c.preview!=b&&(c.preview=b)},i),i.onPreviewRemoveClicked=function(a){a.fileLocalToken;i.previews.remove(a),i.$runtime.removeFileByToken(a.fileLocalToken)},i.onDragOver=function(a){i.enableDragDrop&&(a.preventDefault(),a.stopPropagation())},i.onDrop=function(a){i.enableDragDrop&&(a.preventDefault(),a.stopPropagation(),i.$fileInputProxy.addNewFiles(a.dataTransfer.files))},a.bind(window,"dragover",i.onDragOver),a.bind(window,"drop",i.onDrop),i.addFileClicked=function(b){var c=b.target||b.srcElement;if(i.__inputRegisted||(i.registInput(i,c,!0),i.__inputRegisted=!0),i.useHtml5Runtime)for(var d=a(c),e=0;e<d.element.children.length;e++){var f=d.element.children[e];if("file"==f.type&&1==f.nodeType)return void f.click()}},i.registInput=function(b,c,d){if("string"==typeof b&&(b=a.vmodels[b]),d)b.$fileInputProxy.addEventListenerInput(c);else{var e=void 0;e=-1!=navigator.appName.indexOf("Microsoft")?window.document.getElementById(c):window.document[c],b.$flashEventHub=new g(e),b.$fileInputProxy.bindFlashEvent(b.$flashEventHub)}},i.uploadClicked=function(a){i.uploadAll(i)},i.getInputAcceptTypes=function(a){var b=i.acceptFileTypes.split(","),c="*.*",d=["image.*","audio.*","video.*"];if(a){if(b.indexOf(c)>=0)return[];for(var e=[],f=function(a){var b=[],c=a.replace(".*","/");for(var d in i.$mime)i.$mime.hasOwnProperty(d)&&0==i.$mime[d].indexOf(c)&&b.push("*."+d);e.push({description:c.replace("/",""),types:b.join(";")})},g=0;g<d.length;g++)b.indexOf(d[g])>=0&&f(d[g]);for(var g=0;g<b.length;g++)if(!(d.indexOf(b[g])>=0)){var h=b[g].replace("*.","");e.push({description:h,types:b[g]})}return e}if(b.indexOf(c)>=0)return"*/*";for(var g=0;g<b.length;g++)if(d.indexOf(b[g])>=0)b[g]=b[g].replace(".","/");else{if(!i.$mime.hasOwnProperty(b[g].replace(".","")))continue;b[g]=i.$mime[b[g].replace(".","")]+"/"+b[g].replace(".","")}return b.join(",")},i.rootElement=null,i.$init=function(){i.$runtime=new h(i,j),c.innerHTML=b.replace(/##VM_ID##/gi,i.$id),i.rootElement=c.getElementsByTagName("*")[0],n=[i].concat(n),a.scan(c,n),"function"==typeof q.onInit&&q.onInit.call(c,q,o,n)},i.$remove=function(){this.$runtime.purge()},i.$skipArray=["maxFileSize","filePoolSize","chunked","chunkSize","rootElement","acceptFileTypes","previewWidth","previewHeight","enablePreviewGenerating","enableRemoteKeyGen","enableMd5Validation","serverConfig","noPreviewPath","previewFileTypes","requiredParamsConfig","__inputRegisted"]}));return q};return n.defaults={maxFileSize:10485760,filePoolSize:209715200,chunkSize:1048576,chunked:!1,__inputRegisted:!1,maxFile:5,addButtonText:"Add Files",uploadButtonText:"Upload",acceptFileTypes:"*.*",previewWidth:100,previewHeight:85,enablePreviewGenerating:!0,showPreview:!0,showProgress:!0,multipleFileAllowed:!0,enableRemoteKeyGen:!1,enableMd5Validation:!1,serverConfig:{},$serverConfigDefault:{timeout:3e4,concurrentRequest:3,blobRetryTimes:1,userName:void 0,password:void 0,url:void 0,previewUrl:void 0,keyGenUrl:void 0},requiredParamsConfig:{},$requiredParamsConfig:{blobParamName:"blob",fileTokenParamName:"fileKey",totalChunkParamName:"total",chunkIndexParamName:"chunk",fileNameParamName:"fileName",blobMd5ParamName:"md5"},enableDragDrop:!1,noPreviewPath:"http://source.qunarzz.com/general/oniui/fileuploader/no-preview.png",previewFileTypes:{},$mime:{acx:"application/internet-property-stream",ai:"application/postscript",aif:"audio/x-aiff",aifc:"audio/x-aiff",aiff:"audio/x-aiff",asf:"video/x-ms-asf",asr:"video/x-ms-asf",asx:"video/x-ms-asf",au:"audio/basic",avi:"video/x-msvideo",axs:"application/olescript",bas:"text/plain",bcpio:"application/x-bcpio",bin:"application/octet-stream",bmp:"image/bmp",c:"text/plain",cat:"application/vnd.ms-pkiseccat",cdf:"application/x-cdf",cer:"application/x-x509-ca-cert","class":"application/octet-stream",clp:"application/x-msclip",cmx:"image/x-cmx",cod:"image/cis-cod",cpio:"application/x-cpio",crd:"application/x-mscardfile",crl:"application/pkix-crl",crt:"application/x-x509-ca-cert",csh:"application/x-csh",css:"text/css",dcr:"application/x-director",der:"application/x-x509-ca-cert",dir:"application/x-director",dll:"application/x-msdownload",dms:"application/octet-stream",doc:"application/msword",dot:"application/msword",dvi:"application/x-dvi",dxr:"application/x-director",eps:"application/postscript",etx:"text/x-setext",evy:"application/envoy",exe:"application/octet-stream",fif:"application/fractals",flr:"x-world/x-vrml",gif:"image/gif",gtar:"application/x-gtar",gz:"application/x-gzip",h:"text/plain",hdf:"application/x-hdf",hlp:"application/winhlp",hqx:"application/mac-binhex40",hta:"application/hta",htc:"text/x-component",htm:"text/html",html:"text/html",htt:"text/webviewhtml",ico:"image/x-icon",ief:"image/ief",iii:"application/x-iphone",ins:"application/x-internet-signup",isp:"application/x-internet-signup",jfif:"image/pipeg",jpe:"image/jpeg",jpeg:"image/jpeg",jpg:"image/jpeg",js:"application/x-javascript",latex:"application/x-latex",lha:"application/octet-stream",lsf:"video/x-la-asf",lsx:"video/x-la-asf",lzh:"application/octet-stream",m13:"application/x-msmediaview",m14:"application/x-msmediaview",m3u:"audio/x-mpegurl",man:"application/x-troff-man",mdb:"application/x-msaccess",me:"application/x-troff-me",mht:"message/rfc822",mhtml:"message/rfc822",mid:"audio/mid",mny:"application/x-msmoney",mov:"video/quicktime",movie:"video/x-sgi-movie",mp2:"video/mpeg",mp3:"audio/mpeg",mpa:"video/mpeg",mpe:"video/mpeg",mpeg:"video/mpeg",mpg:"video/mpeg",mpp:"application/vnd.ms-project",mpv2:"video/mpeg",ms:"application/x-troff-ms",mvb:"application/x-msmediaview",nws:"message/rfc822",oda:"application/oda",png:"image/png",p10:"application/pkcs10",p12:"application/x-pkcs12",p7b:"application/x-pkcs7-certificates",p7c:"application/x-pkcs7-mime",p7m:"application/x-pkcs7-mime",p7r:"application/x-pkcs7-certreqresp",p7s:"application/x-pkcs7-signature",pbm:"image/x-portable-bitmap",pdf:"application/pdf",pfx:"application/x-pkcs12",pgm:"image/x-portable-graymap",pko:"application/ynd.ms-pkipko",pma:"application/x-perfmon",pmc:"application/x-perfmon",pml:"application/x-perfmon",pmr:"application/x-perfmon",pmw:"application/x-perfmon",pnm:"image/x-portable-anymap","pot,":"application/vnd.ms-powerpoint",ppm:"image/x-portable-pixmap",pps:"application/vnd.ms-powerpoint",ppt:"application/vnd.ms-powerpoint",prf:"application/pics-rules",ps:"application/postscript",pub:"application/x-mspublisher",qt:"video/quicktime",ra:"audio/x-pn-realaudio",ram:"audio/x-pn-realaudio",ras:"image/x-cmu-raster",rgb:"image/x-rgb",rmi:"audio/mid",roff:"application/x-troff",rtf:"application/rtf",rtx:"text/richtext",scd:"application/x-msschedule",sct:"text/scriptlet",setpay:"application/set-payment-initiation",setreg:"application/set-registration-initiation",sh:"application/x-sh",shar:"application/x-shar",sit:"application/x-stuffit",snd:"audio/basic",spc:"application/x-pkcs7-certificates",spl:"application/futuresplash",src:"application/x-wais-source",sst:"application/vnd.ms-pkicertstore",stl:"application/vnd.ms-pkistl",stm:"text/html",svg:"image/svg+xml",sv4cpio:"application/x-sv4cpio",sv4crc:"application/x-sv4crc",swf:"application/x-shockwave-flash",t:"application/x-troff",tar:"application/x-tar",tcl:"application/x-tcl",tex:"application/x-tex",texi:"application/x-texinfo",texinfo:"application/x-texinfo",tgz:"application/x-compressed",tif:"image/tiff",tiff:"image/tiff",tr:"application/x-troff",trm:"application/x-msterminal",tsv:"text/tab-separated-values",txt:"text/plain",uls:"text/iuls",ustar:"application/x-ustar",vcf:"text/x-vcard",vrml:"x-world/x-vrml",wav:"audio/x-wav",wcm:"application/vnd.ms-works",wdb:"application/vnd.ms-works",wks:"application/vnd.ms-works",wmf:"application/x-msmetafile",wps:"application/vnd.ms-works",wri:"application/x-mswrite",wrl:"x-world/x-vrml",wrz:"x-world/x-vrml",xaf:"x-world/x-vrml",xbm:"image/x-xbitmap",xla:"application/vnd.ms-excel",xlc:"application/vnd.ms-excel",xlm:"application/vnd.ms-excel",xls:"application/vnd.ms-excel",xlt:"application/vnd.ms-excel",xlw:"application/vnd.ms-excel",xof:"x-world/x-vrml",xpm:"image/x-xpixmap",xwd:"image/x-xwindowdump",z:"application/x-compress",zip:"application/zip"},onFileOverSize:a.noop,onSameFileAdded:a.noop,onFilePoolOverSize:a.noop,madeRequestParams:a.noop,uploadAll:function(a){a.previews.forEach(function(b){b.done||a.uploadFile(a,b.fileLocalToken)})},uploadFile:function(a,b){var c=void 0,d=typeof b;if("number"==d)c=a.preview[i].fileLocalToken;else{if("string"!=d)return;c=b}a.$runtime.queueFileByToken(c)},getPreviewByToken:function(a,b){for(var c=null,d=0;d<a.previews.length;d++)if(a.previews[d].fileLocalToken==b){c=a.previews[d];break}return c},getFileKey:function(a,b,c,d){var e=new Promise(function(c,d){a.enableRemoteKeyGen?a.remoteFileKeyGen(a,b,c,d):a.localFileKeyGen(a,b,c,d)});e.then(function(a){c.call(d,a,!0)},function(a){c.call(d,void 0,!1)})},remoteFileKeyGen:function(b,c,d,e){a.ajax({type:"get",url:b.serverConfig.keyGenUrl,timeout:b.serverConfig.timeout||3e4,password:b.serverConfig.password,username:b.serverConfig.userName,cache:!1,success:function(a){d(a)},error:function(a,b){e(b)}})},localFileKeyGen:function(a,b,c,d){c(a.$md5gen(b.name+"#"+b.size+"#"+b.fileLocalToken))},getMd5:function(a,b){return a.$md5gen(b)},compareFileObjects:function(a,b){return a.size==b.size&&a.name==b.name},getFileContext:function(a){var b={canBeAdded:this.testFileBasicInfo(this,a),defaultPreview:!1,enablePreviewGen:!1,previewWidth:0,previewHeight:0,fileLocalToken:void 0,previewUrl:this.serverConfig.previewUrl||null,timeout:this.serverConfig.timeout||null,userName:this.serverConfig.userName||null,password:this.serverConfig.password||null,$env:{supportBase64Img:this.$supportBase64Img,base64Limitation:this.$base64Limitation}};if(b.canBeAdded){var c=a.name,d=this.getFileConfigByExtName(this,c.substr(c.lastIndexOf(".")));b.defaultPreview=d.noPreviewPath,b.enablePreviewGen=d.enablePreview&&d.isImageFile,b.previewWidth=d.previewWidth,b.previewHeight=d.previewHeight}return b},testFileBasicInfo:function(a,b){var c=a.testFileSize(a,b);if(c){for(var d=0;d<a.previews.length;d++)if(a.compareFileObjects(a.previews[d],b))return a.onSameFileAdded.call(a,b),!1;return!0}return!1},testFileSize:function(a,b){var c=a.maxFileSize,d=a.filePoolSize,e=b.size,f=0>=c||c>=e,g=0>=d||a.$runtime.getFilesSizeSum()+e<=d;return f&&g?!0:(f?a.onFilePoolOverSize.call(a,b):a.onFileOverSize.call(a,b),!1)},getFileMessageText:function(a){var b="";switch(a.status){case a.FILE_CACHED:b="File cached.";break;case a.FILE_QUEUED:b="File queued.";break;case a.FILE_IN_UPLOADING:b="\u4e0a\u4f20\u4e2d{0}%".replace("{0}",a.uploadedPercentage);break;case a.FILE_UPLOADED:b="\u4e0a\u4f20\u6210\u529f";break;case a.FILE_ERROR_FAIL_READ:b="";break;case a.FILE_ERROR_FAIL_UPLOAD:b=""}return b},onFileStatusChanged:function(a,b){var c=this.getPreviewByToken(this,a.fileLocalToken);null!=c&&(c.message=this.getFileMessageText(a),a.status==a.FILE_UPLOADED&&(c.uploadProgress=100,c.done=!0))},onFileRequestResponsed:a.noop,getFileConfigByExtName:function(b,c){"string"==typeof b&&(b=a.vmodels[b]);var d=["png","jpg","jpeg","gif"],e=c.replace(".","").toLowerCase(),f={isImageFile:d.indexOf(e)>=0,enablePreview:b.enablePreviewGenerating,previewWidth:b.previewWidth,previewHeight:b.previewHeight,noPreviewPath:b.noPreviewPath,fileSizeLimitation:b.maxFileSize};return!f.isImageFile&&b.previewFileTypes.hasOwnProperty(c)&&(f.noPreviewPath=b.previewFileTypes[c]),f}},a});